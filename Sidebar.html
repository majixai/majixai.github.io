<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; }
    .form-group { margin-bottom: 10px; }
    label { display: block; margin-bottom: 5px; }
    input[type="text"] { width: calc(100% - 22px); padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    button { padding: 10px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background-color: #45a049; }
    #settings-message { margin-top: 10px; font-size: 0.9em; word-wrap: break-word; }
    .loader {
      border: 4px solid #f3f3f3; /* Light grey */
      border-top: 4px solid #3498db; /* Blue */
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 2s linear infinite;
      display: none; /* Hidden by default */
      margin-bottom: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h3>Configuration Settings</h3>
  <div class="form-group">
    <label for="calendar-id">Calendar ID:</label>
    <input type="text" id="calendar-id">
  </div>
  <div class="form-group">
    <label for="drive-folder-id">Drive Folder ID:</label>
    <input type="text" id="drive-folder-id">
  </div>
  <div class="form-group">
    <label for="target-sheet-id">Target Spreadsheet ID (for new sheets):</label>
    <input type="text" id="target-sheet-id">
  </div>
  <button onclick="saveAllSettings()">Save Settings</button>
  <div class="loader" id="settings-loader" style="display: none; margin-top: 5px; margin-bottom: 5px;"></div>
  <div id="settings-message" style="margin-top: 10px; font-size: 0.9em; word-wrap: break-word;"></div>

  <hr>
  <h3>Cache Management</h3>
  <button onclick="clearCache()">Clear Script Cache</button>
  <div class="loader" id="cache-loader" style="display: none; margin-top: 5px; margin-bottom: 5px;"></div>
  <div id="cache-message" style="margin-top: 10px; font-size: 0.9em; word-wrap: break-word;"></div>

  <script>
    document.addEventListener('DOMContentLoaded', loadCurrentSettings);

    function updateStatus(message, type) {
      const statusElement = document.getElementById('settings-message');
      statusElement.innerText = message;
      statusElement.style.color = type === 'success' ? 'green' : (type === 'error' ? 'red' : 'black');

      // Clear message after 5 seconds if it's a success or info message
      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          if (statusElement.innerText === message) {
            statusElement.innerText = '';
          }
        }, 5000);
      }
    }

    // Dummy loadCurrentSettings - actual implementation would call server-side getters
    function loadCurrentSettings() {
      updateStatus('Loading current settings...', 'info');
      document.getElementById('settings-loader').style.display = 'block';
      // Simulate fetching and setting values
      setTimeout(() => {
        // Example: document.getElementById('calendar-id').value = "fetchedCalendarId";
        // Example: document.getElementById('drive-folder-id').value = "fetchedDriveFolderId";
        // Example: document.getElementById('target-sheet-id').value = "fetchedSheetId";
        updateStatus('Settings loaded.', 'success');
        document.getElementById('settings-loader').style.display = 'none';
      }, 1000);
    }

    // Dummy runServerCall - simulates the old helper
    function runServerCall(serverCallPromise, settingName, callback) {
      serverCallPromise
        .withSuccessHandler(response => {
          if (response.success) {
            updateStatus(`${settingName} saved successfully.`, 'success');
          } else {
            updateStatus(`Error saving ${settingName}: ${response.message}`, 'error');
          }
          if (callback) callback();
        })
        .withFailureHandler(error => {
          updateStatus(`Failed to save ${settingName}: ${error.message}`, 'error');
          if (callback) callback();
        });
    }

    // Updated saveAllSettings function
    function saveAllSettings() {
      updateStatus('Saving settings...', 'info');
      document.getElementById('settings-loader').style.display = 'block';

      const calendarId = document.getElementById('calendar-id').value;
      const driveFolderId = document.getElementById('drive-folder-id').value;
      const targetSheetId = document.getElementById('target-sheet-id').value;

      const settingsObject = {
        calendarId: calendarId,
        driveFolderId: driveFolderId,
        targetSheetId: targetSheetId
      };

      google.script.run
        .withSuccessHandler(function(response) {
          document.getElementById('settings-loader').style.display = 'none';
          // Use existing updateStatus function
          updateStatus(response.consolidatedMessage, response.overallSuccess ? 'success' : 'error');
          if (response.overallSuccess) {
            loadCurrentSettings(); // Refresh UI with potentially updated values
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('settings-loader').style.display = 'none';
          // Use existing updateStatus function. Adapt error object if necessary.
          // Assuming 'error' object might have a 'message' property.
          const errorMessage = error && error.message ? error.message : 'An unexpected error occurred while saving settings.';
          updateStatus(errorMessage, 'error');
          console.error('Error saving all settings:', error); // Log for debugging
        })
        .saveAllClientSettings(settingsObject);
    }

    function clearCache() {
      updateStatus('Clearing cache...', 'info'); // Use existing status for now, or create a new one for cache
      document.getElementById('cache-loader').style.display = 'block';
      const cacheStatusElement = document.getElementById('cache-message'); // Specific element for cache messages
      cacheStatusElement.innerText = 'Clearing cache...';
      cacheStatusElement.style.color = 'black';


      google.script.run
        .withSuccessHandler(function(response) {
          document.getElementById('cache-loader').style.display = 'none';
          if (response && response.success) {
            cacheStatusElement.innerText = response.message || 'Cache cleared successfully.';
            cacheStatusElement.style.color = 'green';
          } else {
            cacheStatusElement.innerText = (response && response.message) || 'Failed to clear cache or operation returned no success status.';
            cacheStatusElement.style.color = 'red';
          }
          // Auto-clear message
          setTimeout(() => {
            if (cacheStatusElement.innerText.includes('Cache cleared successfully') || cacheStatusElement.innerText.includes('Failed to clear cache')) {
               cacheStatusElement.innerText = '';
            }
          }, 5000);
        })
        .withFailureHandler(function(error) {
          document.getElementById('cache-loader').style.display = 'none';
          const errorMessage = error && error.message ? error.message : 'An unexpected error occurred while clearing cache.';
          cacheStatusElement.innerText = errorMessage;
          cacheStatusElement.style.color = 'red';
          console.error('Error clearing cache:', error);
          setTimeout(() => {
            if (cacheStatusElement.innerText === errorMessage) {
               cacheStatusElement.innerText = '';
            }
          }, 5000);
        })
        .clearScriptCacheUser(); // Calling the specified server-side function
    }
  </script>
</body>
</html>
