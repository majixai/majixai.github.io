<!DOCTYPE html>
<html>
<head>
  <title>Football Game</title>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body, html {
      height: 100%;
      margin: 0;
    }

    .parallax {
      background-image: url("https://www.w3schools.com/howto/img_parallax.jpg");
      height: 100%;
      background-attachment: fixed;
      background-position: center;
      background-repeat: no-repeat;
      background-size: cover;
    }

    .game-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    canvas {
      background-color: rgba(0, 100, 0, 0.5);
      border: 1px solid #FFFFFF;
    }

    #controller {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
    }

    #d-pad {
      position: relative;
      width: 120px;
      height: 120px;
    }

    .d-pad-button {
      position: absolute;
      width: 40px;
      height: 40px;
      background-color: #555;
      border: 1px solid #FFF;
    }

    #up { top: 0; left: 40px; }
    #down { bottom: 0; left: 40px; }
    #left { top: 40px; left: 0; }
    #right { top: 40px; right: 0; }

    #action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 10px;
      margin-left: 20px;
    }

    .action-button {
      width: 50px;
      height: 50px;
      background-color: #555;
      border: 1px solid #FFF;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
    }

    #shoulder-buttons {
      position: absolute;
      top: -30px;
      width: 100%;
      display: flex;
      justify-content: space-between;
    }

    .shoulder-button {
      width: 60px;
      height: 30px;
      background-color: #555;
      border: 1px solid #FFF;
    }
  </style>
</head>
<body>
  <div class="parallax">
    <div class="game-container">
      <h1 class="w3-text-white">Football Game</h1>
      <div id="play-calling-screen" class="w3-modal">
        <div class="w3-modal-content w3-card-4">
          <header class="w3-container w3-teal">
            <h2>Choose a Play</h2>
          </header>
          <div class="w3-container" id="play-list"></div>
        </div>
      </div>
      <canvas id="gameCanvas"></canvas>
      <div id="commentary" class="w3-panel w3-white w3-card-4"></div>
      <div id="controller">
        <div id="d-pad">
          <div id="up" class="d-pad-button"></div>
          <div id="down" class="d-pad-button"></div>
          <div id="left" class="d-pad-button"></div>
          <div id="right" class="d-pad-button"></div>
        </div>
        <div id="action-buttons">
          <div id="a-button" class="action-button">A</div>
          <div id="b-button" class="action-button">B</div>
          <div id="c-button" class="action-button">C</div>
          <div id="d-button" class="action-button">D</div>
        </div>
        <div id="shoulder-buttons">
          <div id="l-button" class="shoulder-button">L</div>
          <div id="r-button" class="shoulder-button">R</div>
        </div>
      </div>
      <button id="startButton" class="w3-button w3-green">Start</button>
      <button id="stopButton" class="w3-button w3-red">Stop</button>
      <button id="saveButton" class="w3-button w3-blue">Save</button>
      <button id="loadButton" class="w3-button w3-orange">Load</button>
      <div id="settingsPanel" class="w3-panel w3-white w3-card-4">
        <h3>Settings</h3>
        <label for="playerSpeed">Player Speed:</label>
        <input type="range" id="playerSpeed" min="1" max="10" value="5">
        <br>
        <label for="ballColor">Ball Color:</label>
        <input type="color" id="ballColor" value="#FFFFFF">
      </div>
      <svg id="ball-animation" width="100" height="100" style="display: none;">
        <circle cx="50" cy="50" r="40" stroke="black" stroke-width="3" fill="brown" />
        <animate attributeName="r" from="40" to="50" dur="1s" repeatCount="indefinite" />
      </svg>
    </div>
  </div>
  <script src="db.js"></script>
  <script src="playbook.js"></script>
  <script src="special-teams.js"></script>
  <script src="referee.js"></script>
  <script src="settings.js"></script>
  <script src="sprites.js"></script>
  <script src="game.js"></script>
  <script>
    const canvas = document.getElementById('gameCanvas');
    const game = new Game(canvas);
    let gameLoopId;

    document.getElementById('startButton').addEventListener('click', () => {
      if (!gameLoopId) {
        gameLoopId = requestAnimationFrame(() => game.gameLoop());
        document.getElementById('ball-animation').style.display = 'block';
      }
    });

    document.getElementById('stopButton').addEventListener('click', () => {
      if (gameLoopId) {
        cancelAnimationFrame(gameLoopId);
        gameLoopId = null;
        document.getElementById('ball-animation').style.display = 'none';
      }
    });

    document.getElementById('saveButton').addEventListener('click', async () => {
      await openDB();
      await saveGameState(game.getGameState());
      alert('Game saved!');
    });

    document.getElementById('loadButton').addEventListener('click', async () => {
      await openDB();
      const gameState = await loadGameState();
      if (gameState) {
        game.setGameState(gameState);
        alert('Game loaded!');
      } else {
        alert('No saved game found.');
      }
    });

    const keys = {};
    document.addEventListener('keydown', (e) => {
      keys[e.key] = true;
    });
    document.addEventListener('keyup', (e) => {
      keys[e.key] = false;
    });

    const mouse = {
      x: 0,
      y: 0,
    };
    canvas.addEventListener('mousemove', (e) => {
      const rect = canvas.getBoundingClientRect();
      mouse.x = e.clientX - rect.left;
      mouse.y = e.clientY - rect.top;
    });

    function showCommentary(event, details) {
      google.script.run.withSuccessHandler((commentary) => {
        const commentaryDiv = document.getElementById('commentary');
        commentaryDiv.innerHTML = commentary;
      }).getCommentary(event, details);
    }

    function showPlayCallingScreen() {
      const playList = document.getElementById('play-list');
      playList.innerHTML = '';
      for (const formation in playbook.offense.formations) {
        const formationButton = document.createElement('button');
        formationButton.className = 'w3-button w3-block w3-blue';
        formationButton.innerHTML = formation;
        formationButton.onclick = () => {
          showPlaysForFormation(formation);
        };
        playList.appendChild(formationButton);
      }
      document.getElementById('play-calling-screen').style.display = 'block';
    }

    function showPlaysForFormation(formation) {
      const playList = document.getElementById('play-list');
      playList.innerHTML = '';
      for (const play in playbook.offense.formations[formation]) {
        const playButton = document.createElement('button');
        playButton.className = 'w3-button w3-block w3-teal';
        playButton.innerHTML = play;
        playButton.onclick = () => {
          game.currentPlay = playbook.offense.formations[formation][play];
          document.getElementById('play-calling-screen').style.display = 'none';
        };
        playList.appendChild(playButton);
      }
    }

    const controller = {
      up: false,
      down: false,
      left: false,
      right: false,
      a: false,
      b: false,
      c: false,
      d: false,
      l: false,
      r: false,
    };

    document.getElementById('up').addEventListener('mousedown', () => controller.up = true);
    document.getElementById('up').addEventListener('mouseup', () => controller.up = false);
    document.getElementById('down').addEventListener('mousedown', () => controller.down = true);
    document.getElementById('down').addEventListener('mouseup', () => controller.down = false);
    document.getElementById('left').addEventListener('mousedown', () => controller.left = true);
    document.getElementById('left').addEventListener('mouseup', () => controller.left = false);
    document.getElementById('right').addEventListener('mousedown', () => controller.right = true);
    document.getElementById('right').addEventListener('mouseup', () => controller.right = false);
    document.getElementById('a-button').addEventListener('mousedown', () => controller.a = true);
    document.getElementById('a-button').addEventListener('mouseup', () => controller.a = false);
    document.getElementById('b-button').addEventListener('mousedown', () => controller.b = true);
    document.getElementById('b-button').addEventListener('mouseup', () => controller.b = false);
    document.getElementById('c-button').addEventListener('mousedown', () => controller.c = true);
    document.getElementById('c-button').addEventListener('mouseup', () => controller.c = false);
    document.getElementById('d-button').addEventListener('mousedown', () => controller.d = true);
    document.getElementById('d-button').addEventListener('mouseup', () => controller.d = false);
    document.getElementById('l-button').addEventListener('mousedown', () => controller.l = true);
    document.getElementById('l-button').addEventListener('mouseup', () => controller.l = false);
    document.getElementById('r-button').addEventListener('mousedown', () => controller.r = true);
    document.getElementById('r-button').addEventListener('mouseup', () => controller.r = false);

    document.getElementById('playerSpeed').addEventListener('input', (e) => {
      settings.player.speed = e.target.value;
      game.player.speed = e.target.value;
    });

    document.getElementById('ballColor').addEventListener('input', (e) => {
      settings.ball.color = e.target.value;
      game.ball.color = e.target.value;
    });

    // Initialize settings panel
    document.getElementById('playerSpeed').value = settings.player.speed;
    document.getElementById('ballColor').value = settings.ball.color;
  </script>
</body>
</html>
