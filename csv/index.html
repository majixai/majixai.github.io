<!DOCTYPE html>
<html>
<head>
    <title>Plotly Candlestick with Indicators</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: sans-serif; }
        .input-section { margin-bottom: 20px; }
        .input-section label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-section input, .input-section select { padding: 8px; width: calc(100% - 20px); margin-bottom: 10px; border: 1px solid #ccc; }
        button { padding: 10px 15px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
        button:hover { background-color: #0056b3; }
        #plot-area { width: 800px; height: 600px; margin-top: 20px; }
        #indicator-data { margin-top: 20px; padding: 15px; border: 1px solid #ddd; }
        #indicator-data h2 { margin-top: 0; }
        #covariance-display, #stdev-display, #black-scholes-display, #error-display { margin-bottom: 10px; }
        #covariance-display pre, #stdev-display pre, #black-scholes-display pre, #error-display pre { background-color: #f8f8f8; padding: 10px; border: 1px solid #eee; }
        #error-display pre { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Plotly Candlestick Chart with Indicators</h1>

    <div class="input-section">
        <label for="ticker1">Ticker 1:</label>
        <input type="text" id="ticker1" value="AAPL" placeholder="Enter Ticker 1 (e.g., AAPL)">
    </div>

    <div class="input-section">
        <label for="ticker2">Ticker 2 (Optional for Covariance):</label>
        <input type="text" id="ticker2" placeholder="Enter Ticker 2 (Optional)">
    </div>

    <div class="input-section">
        <label for="interval">Interval:</label>
        <select id="interval">
            <option value="1m">1 Minute</option>
            <option value="5m">5 Minutes</option>
            <option value="1h">1 Hour</option>
            <option value="1d" selected>1 Day</option>
        </select>
    </div>

    <button id="plot-button">Fetch Data and Plot</button>

    <div id="plot-area"></div>

    <div id="indicator-data">
        <h2>Indicator Data</h2>
        <div id="covariance-display">
            <h3>Covariance (Open & Close of Ticker 1):</h3>
            <pre id="covariance-output">N/A</pre>
        </div>
        <div id="stdev-display">
            <h3>Standard Deviation (Close Price Ticker 1):</h3>
            <pre id="stdev-output">N/A</pre>
        </div>
        <div id="black-scholes-display">
            <h3>Black-Scholes (Simplified Volatility - Placeholder):</h3>
            <pre id="black-scholes-output">Black-Scholes calculation requires more inputs and a proper model. Placeholder.</pre>
        </div>
        <div id="error-display">
            <pre id="error-output"></pre>
        </div>
    </div>

    <script>
        document.getElementById('plot-button').addEventListener('click', function() {
            alert("Button clicked!"); // <--- Changed to alert
            fetchDataAndPlot();
        });
    
        const intervalPeriodMap = {
            '1m': '5d',
            '5m': '5d',
            '1h': '5d',
            '1d': '1y'
        };
    
        async function fetchDataAndPlot() {
            alert("fetchDataAndPlot started"); // <--- Changed to alert
    
            const ticker1 = document.getElementById('ticker1').value.toUpperCase();
            const ticker2 = document.getElementById('ticker2').value.toUpperCase();
            const interval = document.getElementById('interval').value;
            const period = intervalPeriodMap[interval];
    
            document.getElementById('error-output').textContent = '';
    
            const csvURL1 = `placeholder_data/${ticker1}_${interval}_${period}.csv`;
            const csvURL2 = ticker2 ? `placeholder_data/${ticker2}_${interval}_${period}.csv` : null;
    
            try {
                alert("Before fetchCSVData(csvURL1)"); // <--- Changed to alert
                const data1 = await fetchCSVData(csvURL1);
                alert("After fetchCSVData(csvURL1), data1: " + JSON.stringify(data1)); // <--- Changed to alert, need to stringify data
                let data2 = null;
                if (csvURL2) {
                    alert("Before fetchCSVData(csvURL2)"); // <--- Changed to alert
                    data2 = await fetchCSVData(csvURL2);
                    alert("After fetchCSVData(csvURL2), data2: " + JSON.stringify(data2)); // <--- Changed to alert, need to stringify data
                }
                alert("Before plotCandlestickChart"); // <--- Changed to alert
                plotCandlestickChart(data1, ticker1);
                alert("After plotCandlestickChart"); // <--- Changed to alert
                alert("Before calculateAndDisplayIndicators"); // <--- Changed to alert
                calculateAndDisplayIndicators(data1, data2, ticker1, ticker2);
                alert("After calculateAndDisplayIndicators"); // <--- Changed to alert
    
            } catch (error) {
                console.error("Error in fetchDataAndPlot:", error); // Keep console.error for actual errors
                document.getElementById('error-output').textContent = `Error: Could not fetch data for ${ticker1}. Check console for details.`;
            }
             alert("fetchDataAndPlot finished (or error caught)"); // <--- Changed to alert
        }
    
        async function fetchCSVData(url) {
            alert("fetchCSVData started, URL: " + url); // <--- Changed to alert
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}, URL: ${url}`);
            }
            const csvText = await response.text();
            alert("fetchCSVData finished, CSV text length: " + csvText.length); // <--- Changed to alert
            return parseCSV(csvText);
        }
    
        function parseCSV(csvText) {
            alert("parseCSV started, CSV text length: " + csvText.length); // <--- Changed to alert
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',');
            const data = { dates: [], open: [], high: [], low: [], close: [], volume: [] };
    
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length === headers.length) { // Basic validation
                    try {
                        data.dates.push(new Date(values[0])); // Assuming Date is first column
                        data.open.push(parseFloat(values[1])); // Open price
                        data.high.push(parseFloat(values[2])); // High price
                        data.low.push(parseFloat(values[3]));  // Low price
                        data.close.push(parseFloat(values[4])); // Close price
                        data.volume.push(parseFloat(values[5]));// Volume
                    } catch (e) {
                        console.warn("Skipping row due to parsing error:", values, e); // Keep console.warn for warnings
                    }
                } else {
                    console.warn("Skipping row due to incorrect number of columns:", values); // Keep console.warn for warnings
                }
            }
            alert("parseCSV finished, data: " + JSON.stringify(data)); // <--- Changed to alert, need to stringify data
            return data;
        }
    
        function plotCandlestickChart(data, ticker) {
            alert("plotCandlestickChart started, ticker: " + ticker + ", data: " + JSON.stringify(data)); // <--- Changed to alert, need to stringify data
            const trace = {
                x: data.dates,
                type: 'candlestick',
                open: data.open,
                high: data.high,
                low: data.low,
                close: data.close,
                name: ticker,
                yaxis: 'y',
            };
    
            const layout = {
                title: `Candlestick Chart for ${ticker}`,
                xaxis: { title: 'Date' },
                yaxis: { title: 'Price' }
            };
    
            Plotly.newPlot('plot-area', [trace], layout);
            alert("plotCandlestickChart finished"); // <--- Changed to alert
        }
    
        function calculateAndDisplayIndicators(data1, data2, ticker1, ticker2) {
            alert("calculateAndDisplayIndicators started, tickers: " + ticker1 + ", " + ticker2 + ", data1: " + JSON.stringify(data1) + ", data2: " + JSON.stringify(data2)); // <--- Changed to alert, need to stringify data
            const covariance = calculateCovariance(data1.open, data1.close);
            document.getElementById('covariance-output').textContent = covariance.toFixed(4) || 'N/A';
            alert("Covariance calculated: " + covariance); // <--- Changed to alert
    
            const stdev = calculateStandardDeviation(data1.close);
            document.getElementById('stdev-output').textContent = stdev.toFixed(4) || 'N/A';
            alert("Standard Deviation calculated: " + stdev); // <--- Changed to alert
    
    
            alert("calculateAndDisplayIndicators finished"); // <--- Changed to alert
            // Black-Scholes placeholder remains as is in HTML <pre id="black-scholes-output">
    
        }
    
        function calculateCovariance(arr1, arr2) {
            alert("calculateCovariance started, arr1 length: " + arr1.length + ", arr2 length: " + arr2.length); // <--- Changed to alert
            if (!arr1 || !arr2 || arr1.length !== arr2.length || arr1.length < 2) return NaN;
    
            const n = arr1.length;
            const mean1 = arr1.reduce((a, b) => a + b, 0) / n;
            const mean2 = arr2.reduce((a, b) => a + b, 0) / n;
    
            let covarianceSum = 0;
            for (let i = 0; i < n; i++) {
                covarianceSum += (arr1[i] - mean1) * (arr2[i] - mean2);
            }
            const result = covarianceSum / (n - 1); // Sample covariance
            alert("calculateCovariance finished, result: " + result); // <--- Changed to alert
            return result;
        }
    
        function calculateStandardDeviation(arr) {
            alert("calculateStandardDeviation started, arr length: " + arr.length); // <--- Changed to alert
            if (!arr || arr.length < 2) return NaN;
            const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
            const sqDiffArray = arr.map(val => (val - mean) ** 2);
            const avgSqDiff = sqDiffArray.reduce((a, b) => a + b, 0) / (arr.length - 1);
            const result = Math.sqrt(avgSqDiff);
            alert("calculateStandardDeviation finished, result: " + result); // <--- Changed to alert
            return result;
        }
    
    
        function testPlotly() { // Example test function
            Plotly.newPlot('plot-area', [{
                y: [10, 15, 13, 17]
            }], {
                title: 'A Simple Plotly Test'
            });
            alert("testPlotly function executed, simple plot should be visible."); // <--- Changed to alert
        }
    
        //testPlotly(); // You can uncomment this to run the test on page load if needed
    
    </script>
    
</body>
</html>
