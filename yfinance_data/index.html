<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Comprehensive stock market analysis with AI-powered mathematical engines">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="YFinance">
    
    <title>YFinance Data Analytics - AI-Powered Stock Analysis</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Error Tracking -->
    <script src="error-tracking.js"></script>
</head>
<body>
    <div class="header-container">
        <h1>YFinance Data Analytics</h1>
        <button id="error-settings-btn" class="error-settings-btn" title="Error Tracking & Settings">
            ‚öôÔ∏è <span id="error-count-badge" class="error-badge">0</span>
        </button>
        <div class="controls-panel">
            <div class="search-box">
                <input type="text" id="ticker-search" placeholder="üîç Search ticker (e.g., AAPL)..." autocomplete="off">
                <div id="autocomplete-dropdown" class="autocomplete-dropdown"></div>
            </div>
            <div class="filter-controls">
                <select id="sort-select">
                    <option value="ticker-asc">Ticker (A‚ÜíZ)</option>
                    <option value="ticker-desc">Ticker (Z‚ÜíA)</option>
                    <option value="price-asc">Price (Low‚ÜíHigh)</option>
                    <option value="price-desc">Price (High‚ÜíLow)</option>
                    <option value="date-asc">Date (Old‚ÜíNew)</option>
                    <option value="date-desc" selected>Date (New‚ÜíOld)</option>
                    <option value="relevance">Relevance (Best Match)</option>
                </select>
                <select id="price-filter">
                    <option value="all">All Prices</option>
                    <option value="under-10">Under $10</option>
                    <option value="10-50">$10 - $50</option>
                    <option value="50-100">$50 - $100</option>
                    <option value="100-500">$100 - $500</option>
                    <option value="over-500">Over $500</option>
                </select>
                <button id="clear-filters" class="btn-secondary">üîÑ Reset</button>
            </div>
        </div>
    </div>
    
    <div id="loader" class="loader-container">
        <div class="loader-spinner"></div>
        <div id="loader-text" class="loader-text">Initializing...</div>
        <div id="loader-details" class="loader-details"></div>
        <div id="loader-progress" class="loader-progress">
            <div id="loader-progress-bar" class="loader-progress-bar"></div>
        </div>
    </div>
    <div id="data-container"></div>
    <div id="pagination-container"></div>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/sql-wasm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Enhanced System Scripts -->
    <script src="indexeddb.js"></script>
    <script src="actions.js"></script>
    
    <!-- Main Application Script -->
    <script src="script.js"></script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Register Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('service-worker.js');
                    console.log('‚úì Service Worker registered:', registration.scope);
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('üîÑ Service Worker update found');
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('‚ú® New version available! Refresh to update.');
                                // Show update notification to user
                                if (confirm('A new version is available. Reload to update?')) {
                                    window.location.reload();
                                }
                            }
                        });
                    });
                } catch (error) {
                    console.log('Service Worker registration failed:', error);
                }
            });
        }
        
        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('üíæ App install available');
            
            // Show custom install button if you have one
            const installButton = document.getElementById('install-button');
            if (installButton) {
                installButton.style.display = 'block';
                installButton.addEventListener('click', async () => {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response to install prompt: ${outcome}`);
                    deferredPrompt = null;
                    installButton.style.display = 'none';
                });
            }
        });
        
        // Track when app is installed
        window.addEventListener('appinstalled', () => {
            console.log('‚úì App installed successfully');
            deferredPrompt = null;
        });
        
        // Initialize IndexedDB
        window.addEventListener('load', async () => {
            try {
                await window.DB.init();
                console.log('‚úì IndexedDB initialized');
                
                // Clean expired cache on startup
                const deleted = await window.DB.clearExpiredCache();
                if (deleted > 0) {
                    console.log(`üßπ Cleaned ${deleted} expired cache entries`);
                }
            } catch (error) {
                console.error('Failed to initialize IndexedDB:', error);
            }
        });
    </script>
    
    <!-- Advanced Mathematics Library -->
    <script src="advanced_math.js"></script>
    
    <!-- Bitcoin Mining Demo -->
    <script src="bitcoin_miner.js"></script>
    <script>
        // Add miner control button to header
        document.addEventListener('DOMContentLoaded', () => {
            const header = document.querySelector('.header-container');
            if (header && window.BitcoinMiner) {
                const minerBtn = document.createElement('button');
                minerBtn.id = 'launch-miner';
                minerBtn.className = 'miner-launch-btn';
                minerBtn.innerHTML = '‚ö° Mining Demo';
                minerBtn.style.cssText = `
                    padding: 10px 20px;
                    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                    margin-left: 15px;
                    transition: all 0.3s;
                    font-size: 14px;
                `;
                minerBtn.onmouseover = () => {
                    minerBtn.style.transform = 'translateY(-2px)';
                    minerBtn.style.boxShadow = '0 5px 15px rgba(245, 158, 11, 0.4)';
                };
                minerBtn.onmouseout = () => {
                    minerBtn.style.transform = 'translateY(0)';
                    minerBtn.style.boxShadow = 'none';
                };
                minerBtn.onclick = () => {
                    window.BitcoinMiner.start();
                };
                header.appendChild(minerBtn);
            }
        });
        
        // Initialize Error Tracker
        if (window.ErrorTracker) {
            window.ErrorTracker.init();
            
            // Add CSS for error settings button
            const style = document.createElement('style');
            style.textContent = `
                .error-settings-btn {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                    color: white;
                    border: none;
                    border-radius: 50px;
                    font-size: 18px;
                    font-weight: 600;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
                    transition: all 0.3s;
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
                .error-settings-btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
                }
                .error-badge {
                    display: none;
                    background: white;
                    color: #dc3545;
                    padding: 2px 8px;
                    border-radius: 12px;
                    font-size: 14px;
                    font-weight: 700;
                }
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
            
            // Add error settings modal
            const modal = document.createElement('div');
            modal.id = 'error-settings-modal';
            modal.style.cssText = `
                display: none;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.7);
            `;
            
            modal.innerHTML = `
                <div style="
                    position: relative;
                    margin: 5% auto;
                    padding: 30px;
                    width: 90%;
                    max-width: 600px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 20px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                    color: white;
                ">
                    <span style="
                        position: absolute;
                        right: 20px;
                        top: 20px;
                        font-size: 32px;
                        font-weight: bold;
                        cursor: pointer;
                        opacity: 0.7;
                        transition: opacity 0.3s;
                    " onclick="document.getElementById('error-settings-modal').style.display='none'">&times;</span>
                    
                    <h2 style="margin-top: 0; font-size: 28px;">‚öôÔ∏è Error Tracking & Settings</h2>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin: 20px 0;">
                        <h3 style="margin-top: 0;">üìä Session Information</h3>
                        <p><strong>Session ID:</strong> <span id="modal-session-id"></span></p>
                        <p><strong>Client Hash:</strong> <span id="modal-client-hash"></span></p>
                        <p><strong>Total Errors:</strong> <span id="modal-error-count">0</span></p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                        <button onclick="copyAllErrors()" style="
                            padding: 15px;
                            background: rgba(255,255,255,0.2);
                            border: 2px solid rgba(255,255,255,0.3);
                            border-radius: 12px;
                            color: white;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s;
                        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                           onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            üìã Copy All Errors
                        </button>
                        
                        <button onclick="exportErrorLog()" style="
                            padding: 15px;
                            background: rgba(255,255,255,0.2);
                            border: 2px solid rgba(255,255,255,0.3);
                            border-radius: 12px;
                            color: white;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s;
                        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                           onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            üíæ Export to File
                        </button>
                        
                        <button onclick="clearAllErrors()" style="
                            padding: 15px;
                            background: rgba(220, 53, 69, 0.3);
                            border: 2px solid rgba(220, 53, 69, 0.5);
                            border-radius: 12px;
                            color: white;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s;
                        " onmouseover="this.style.background='rgba(220, 53, 69, 0.5)'" 
                           onmouseout="this.style.background='rgba(220, 53, 69, 0.3)'">
                            üóëÔ∏è Clear Errors
                        </button>
                        
                        <button onclick="window.location.href='client-tracking.html'" style="
                            padding: 15px;
                            background: rgba(40, 167, 69, 0.3);
                            border: 2px solid rgba(40, 167, 69, 0.5);
                            border-radius: 12px;
                            color: white;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s;
                        " onmouseover="this.style.background='rgba(40, 167, 69, 0.5)'" 
                           onmouseout="this.style.background='rgba(40, 167, 69, 0.3)'">
                            üîç Full Dashboard
                        </button>
                    </div>
                    
                    <div id="recent-errors-list" style="
                        max-height: 200px;
                        overflow-y: auto;
                        background: rgba(0,0,0,0.2);
                        padding: 15px;
                        border-radius: 12px;
                        margin-top: 20px;
                    ">
                        <h3 style="margin-top: 0;">üî¥ Recent Errors</h3>
                        <div id="recent-errors-content">Loading...</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Settings button handler
            const settingsBtn = document.getElementById('error-settings-btn');
            if (settingsBtn) {
                settingsBtn.onclick = () => {
                    updateModalStats();
                    modal.style.display = 'block';
                };
            }
            
            // Update error count badge periodically
            setInterval(() => {
                const badge = document.getElementById('error-count-badge');
                if (badge && window.ErrorTracker) {
                    const errorCount = window.ErrorTracker.errors.filter(e => e.type !== 'event').length;
                    badge.textContent = errorCount;
                    badge.style.display = errorCount > 0 ? 'inline-block' : 'none';
                }
            }, 2000);
        }
        
        // Modal helper functions
        window.updateModalStats = function() {
            if (!window.ErrorTracker) return;
            
            document.getElementById('modal-session-id').textContent = window.ErrorTracker.sessionId;
            document.getElementById('modal-client-hash').textContent = window.ErrorTracker.clientHash;
            
            const errors = window.ErrorTracker.errors.filter(e => e.type !== 'event');
            document.getElementById('modal-error-count').textContent = errors.length;
            
            const recentErrorsContent = document.getElementById('recent-errors-content');
            if (errors.length === 0) {
                recentErrorsContent.innerHTML = '<p style="opacity: 0.7; font-style: italic;">No errors logged</p>';
            } else {
                recentErrorsContent.innerHTML = errors.slice(-5).reverse().map(err => `
                    <div style="
                        padding: 10px;
                        margin: 5px 0;
                        background: rgba(220, 53, 69, 0.2);
                        border-left: 3px solid #dc3545;
                        border-radius: 6px;
                        font-size: 13px;
                    ">
                        <strong>${err.type}</strong>: ${err.message}<br>
                        <small style="opacity: 0.8;">${new Date(err.timestamp).toLocaleString()}</small>
                    </div>
                `).join('');
            }
        };
        
        window.copyAllErrors = async function() {
            if (!window.ErrorTracker) return;
            await window.ErrorTracker.copyToClipboard();
            showToast('‚úÖ Errors copied to clipboard!');
        };
        
        window.exportErrorLog = function() {
            if (!window.ErrorTracker) return;
            window.ErrorTracker.exportToFile();
            showToast('‚úÖ Error log downloaded!');
        };
        
        window.clearAllErrors = function() {
            if (!window.ErrorTracker) return;
            if (confirm('Are you sure you want to clear all logged errors?')) {
                window.ErrorTracker.clearErrors();
                updateModalStats();
                showToast('üóëÔ∏è All errors cleared!');
            }
        };
        
        window.showToast = function(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                right: 30px;
                background: rgba(40, 167, 69, 0.95);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                font-weight: 600;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10001;
                animation: slideIn 0.3s ease-out;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        };
    </script>
</body>
</html>
