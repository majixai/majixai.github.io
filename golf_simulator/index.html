<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>Golf Simulator</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
      body {
          font-family: Arial, sans-serif;
      }
      #golf-course {
          background-color: #228B22; /* Forest Green */
          border: 1px solid #000;
      }
      .ball { fill: white; }
      .hole { fill: black; }
      .parallax {
        background-image: url("https://www.w3schools.com/howto/img_parallax.jpg");
        min-height: 500px;
        background-attachment: fixed;
        background-position: center;
        background-repeat: no-repeat;
        background-size: cover;
      }
    </style>
  </head>
  <body>

    <!-- Sidebar -->
    <div class="w3-sidebar w3-bar-block w3-card w3-animate-left" style="display:none;z-index:5" id="mySidebar">
      <button class="w3-bar-item w3-button w3-large" onclick="w3_close()">Close &times;</button>
      <div class="w3-container">
        <h3 class="w3-center">Controls</h3>
        <div class="w3-center">
            <h4>Score: <span id="score">0</span> | High Score: <span id="high-score">0</span></h4>
            <button id="start-button" class="w3-button w3-green w3-margin-bottom">Start</button>
            <button id="stop-button" class="w3-button w3-red w3-margin-bottom">Stop</button>
        </div>
        <hr>
        <div id="ai-section">
            <h3 class="w3-center">AI Golf Coach</h3>
            <button id="get-tip-button" class="w3-button w3-blue w3-block">Get a Swing Tip</button>
            <div id="tip-display" class="w3-panel w3-light-grey w3-padding" style="display:none;"></div>
        </div>
      </div>
    </div>

    <!-- Page Content -->
    <div id="main">
        <div class="w3-teal">
          <button id="openNav" class="w3-button w3-teal w3-xlarge" onclick="w3_open()">&#9776;</button>
          <div class="w3-container">
            <h1>Golf Simulator</h1>
          </div>
        </div>

        <div class="parallax">
            <div class="container-fluid" style="background-color: rgba(255,255,255,0.8); padding: 20px;">
              <div class="row">
                <div class="col-md-6">
                  <h2 class="text-center">Camera View</h2>
                  <video id="video" width="100%" autoplay class="w3-card-4"></video>
                </div>
                <div class="col-md-6">
                  <h2 class="text-center">Golf Course</h2>
                  <svg id="golf-course" width="100%" height="400px" class="w3-card-4">
                    <rect width="100%" height="100%" fill="#228B22" />
                    <circle id="hole" cx="90%" cy="50%" r="15" fill="black" />
                    <circle id="ball" cx="10%" cy="50%" r="8" fill="white" />
                  </svg>
                </div>
              </div>
            </div>
        </div>

        <div style="height:400px;background-color:#003300;color:white;font-size:24px;text-align:center;padding: 50px;">
            <h2 class="w3-xxlarge">About this Project</h2>
            <p class="w3-large">This golf simulator uses your camera to detect motion and simulate a golf swing.</p>
            <p class="w3-large">It's built with a variety of advanced JavaScript concepts, including Object-Oriented Programming, IndexedDB for score persistence, and modern ES6+ features.</p>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      function w3_open() {
        document.getElementById("main").style.marginLeft = "25%";
        document.getElementById("mySidebar").style.width = "25%";
        document.getElementById("mySidebar").style.display = "block";
        document.getElementById("openNav").style.display = 'none';
      }
      function w3_close() {
        document.getElementById("main").style.marginLeft = "0%";
        document.getElementById("mySidebar").style.display = "none";
        document.getElementById("openNav").style.display = "inline-block";
      }

      (function() {
          // IIFE for private scope

          // --- App Configuration ---
          let config = {
              motionThresholdDivisor: 1000,
              swingPowerMultiplier: 0.05,
              maxSwingPower: 20
          };

          // --- JSDoc "Interfaces" ---
          /**
           * @typedef {Object} IBall
           * @property {HTMLElement} element
           * @property {number} radius
           * @property {number} x
           * @property {number} y
           * @property {number} vx
           * @property {number} vy
           * @property {function(): void} update
           * @property {function(): boolean} isMoving
           * @property {function(): void} reset
           */

          /**
           * @typedef {Object} IGame
           * @property {IBall} ball
           * @property {function(number, number): void} swing
           * @property {function(): void} stop
           */

          // --- DOM Elements ---
          const video = document.getElementById('video');
          const startButton = document.getElementById('start-button');
          const stopButton = document.getElementById('stop-button');
          const golfCourseSVG = document.getElementById('golf-course');
          const ballSVG = document.getElementById('ball');
          const scoreEl = document.getElementById('score');
          const highScoreEl = document.getElementById('high-score');


          // --- DBHelper Class for IndexedDB ---
          class DBHelper {
              constructor(dbName, storeName, version = 1) {
                  this.dbName = dbName;
                  this.storeName = storeName;
                  this.version = version;
                  this.db = null;
              }

              open() {
                  return new Promise((resolve, reject) => {
                      const request = indexedDB.open(this.dbName, this.version);
                      request.onerror = (event) => reject("Error opening DB: " + event.target.errorCode);
                      request.onsuccess = (event) => {
                          this.db = event.target.result;
                          resolve(this.db);
                      };
                      request.onupgradeneeded = (event) => {
                          const db = event.target.result;
                          if (!db.objectStoreNames.contains(this.storeName)) {
                              db.createObjectStore(this.storeName, { keyPath: 'id', autoIncrement: true });
                          }
                      };
                  });
              }

              async put(item) {
                  if (!this.db) await this.open();
                  return new Promise((resolve, reject) => {
                      const transaction = this.db.transaction([this.storeName], 'readwrite');
                      const store = transaction.objectStore(this.storeName);
                      const request = store.put(item);
                      request.onsuccess = () => resolve(request.result);
                      request.onerror = (event) => reject("Error putting item: " + event.target.errorCode);
                  });
              }

              async getAll() {
                  if (!this.db) await this.open();
                  return new Promise((resolve, reject) => {
                      const transaction = this.db.transaction([this.storeName], 'readonly');
                      const store = transaction.objectStore(this.storeName);
                      const request = store.getAll();
                      request.onsuccess = () => resolve(request.result);
                      request.onerror = (event) => reject("Error getting all items: " + event.target.errorCode);
                  });
              }
          }


          // --- Motion Detection Globals ---
          let motionDetectionLoopId;
          let lastImageData;
          const canvas = document.createElement('canvas');
          const canvasContext = canvas.getContext('2d', { willReadFrequently: true });

          // --- Classes ---

          class Ball {
              static FRICTION = 0.98; // Static property

              constructor(element) {
                  this.element = element;
                  this.radius = parseFloat(element.getAttribute('r'));
                  this.x = parseFloat(element.getAttribute('cx'));
                  this.y = parseFloat(element.getAttribute('cy'));
                  this.vx = 0;
                  this.vy = 0;
              }

              update() {
                  this.x += this.vx;
                  this.y += this.vy;
                  this.vx *= Ball.FRICTION;
                  this.vy *= Ball.FRICTION;

                  this.element.setAttribute('cx', this.x);
                  this.element.setAttribute('cy', this.y);
              }

              isMoving() {
                  return Math.abs(this.vx) > 0.1 || Math.abs(this.vy) > 0.1;
              }

              reset() {
                  this.x = parseFloat(this.element.dataset.startX) || 100;
                  this.y = parseFloat(this.element.dataset.startY) || 200;
                  this.vx = 0;
                  this.vy = 0;
                  this.update();
              }
          }

          class Game {
              // Bitwise flags for game status
              static STATUS_READY = 1 << 0; // 1
              static STATUS_SWINGING = 1 << 1; // 2

              #status; // Private field
              #animationFrameId;

              lastSwingData = { power: 0, angle: 0 };

              constructor(ball, dbHelper, options = {}) {
                  /** @type {IBall} */
                  this.ball = ball;
                  this.dbHelper = dbHelper;
                  this.options = Object.assign({
                      swingPowerMultiplier: 0.1,
                      maxSwingPower: 20
                  }, options); // Object Mapping

                  this.#status = Game.STATUS_READY;
                  this.#animationFrameId = null;
                  this.score = 0;
                  this.highScore = 0;
              }

              async loadGame() {
                  try {
                      const scores = await this.dbHelper.getAll();
                      if (scores.length > 0) {
                          this.highScore = scores.reduce((max, s) => Math.max(max, s.score), 0);
                      }
                      console.log(`High score loaded: ${this.highScore}`);
                      this.updateScoreUI();
                  } catch (error) {
                      console.error("Could not load high score:", error);
                  }
              }

              updateScoreUI() {
                  scoreEl.textContent = this.score;
                  highScoreEl.textContent = this.highScore;
              }


              swing(power, angle) {
                  if (this.#status & Game.STATUS_SWINGING) return;
                  this.#status = Game.STATUS_SWINGING;

                  this.score++;
                  this.updateScoreUI();

                  this.lastSwingData = { power, angle };

                  console.log(`Swinging with power ${power} and angle ${angle}`);
                  const swingPower = Math.min(power * this.options.swingPowerMultiplier, this.options.maxSwingPower);

                  this.ball.vx = Math.cos(angle) * swingPower;
                  this.ball.vy = Math.sin(angle) * swingPower;
                  this.animate();
              }

              * _gameStateMachine() {
                  while (true) {
                      if (this.ball.isMoving()) {
                          yield 'MOVING';
                          this.ball.update();
                      } else {
                          yield 'STOPPED';
                          this.#status = Game.STATUS_READY;
                          this.#animationFrameId = null;
                          return; // End the generator
                      }
                  }
              }

              animate() {
                  const stateMachine = this._gameStateMachine();

                  const loop = () => {
                      const state = stateMachine.next().value;
                      if (state === 'MOVING') {
                          this.#animationFrameId = requestAnimationFrame(loop);
                      } else {
                          console.log("Ball stopped.");
                      }
                  };
                  loop();
              }

              async stop() {
                  if (this.#animationFrameId) {
                      cancelAnimationFrame(this.#animationFrameId);
                  }
                  this.ball.reset();
                  this.#status = Game.STATUS_READY;

                  if (this.score > 0) {
                      await this.dbHelper.put({ score: this.score, date: new Date() });
                      console.log("Game score saved.");
                      if (this.score > this.highScore) {
                          this.highScore = this.score;
                      }
                  }
                  this.score = 0;
                  this.updateScoreUI();
              }
          }

          // --- Initial Setup ---
          ballSVG.dataset.startX = ballSVG.getAttribute('cx');
          ballSVG.dataset.startY = ballSVG.getAttribute('cy');

          const dbHelper = new DBHelper('GolfSimulatorDB', 'scores');
          const ball = new Ball(ballSVG);
          const game = new Game(ball, dbHelper, config);


          // --- Motion Detection ---
          function setupCanvas() {
              if (video.videoWidth > 0) {
                  canvas.width = video.videoWidth;
                  canvas.height = video.videoHeight;
              }
          }

          function detectMotion(onMotion) {
              if (video.readyState < video.HAVE_METADATA || video.videoWidth === 0) return;
              if (canvas.width === 0) setupCanvas();

              canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
              const currentImageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);

              if (lastImageData) {
                  let motionAmount = 0;
                  const data = currentImageData.data;
                  const lastData = lastImageData.data;

                  for (let i = 0; i < data.length; i += 4) {
                      const diff = Math.abs(data[i] - lastData[i]) + Math.abs(data[i + 1] - lastData[i + 1]) + Math.abs(data[i + 2] - lastData[i + 2]);
                      if (diff > 50) motionAmount++;
                  }

                  const motionThreshold = (canvas.width * canvas.height) / config.motionThresholdDivisor;
                  if (motionAmount > motionThreshold) {
                      onMotion(motionAmount);
                  }
              }
              lastImageData = currentImageData;
          }

          function motionDetectionLoop() {
              detectMotion((motionAmount) => {
                  console.log(`Motion detected! Amount: ${motionAmount}`);
                  const power = motionAmount;
                  const angle = (Math.random() - 0.5) * 0.5; // Random angle for now
                  game.swing(power, angle);
              });
              motionDetectionLoopId = requestAnimationFrame(motionDetectionLoop);
          }

          // --- Main Functions ---
          async function initCamera() {
              try {
                  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                  video.srcObject = stream;
              } catch (err) {
                  console.error("Error accessing camera: ", err);
              }
          }

          async function startGame() {
              console.log("Starting game...");

              await new Promise(resolve => {
                  google.script.run
                      .withSuccessHandler(props => {
                          if (props) {
                              config.motionThresholdDivisor = parseFloat(props.MOTION_THRESHOLD_DIVISOR) || config.motionThresholdDivisor;
                              config.swingPowerMultiplier = parseFloat(props.SWING_POWER_MULTIPLIER) || config.swingPowerMultiplier;
                              config.maxSwingPower = parseFloat(props.MAX_SWING_POWER) || config.maxSwingPower;
                              console.log("Remote config loaded:", config);
                          }
                          resolve();
                      })
                      .withFailureHandler(err => {
                          console.error("Could not load remote config:", err);
                          resolve(); // Resolve anyway to let the game start
                      })
                      .getAppProperties();
              });

              await game.loadGame();
              initCamera();
              motionDetectionLoop();
          }

          function stopGame() {
              console.log("Stopping game...");
              if (motionDetectionLoopId) {
                  cancelAnimationFrame(motionDetectionLoopId);
              }
              game.stop(); // game.stop is now async, but we don't need to wait for it here
              let stream = video.srcObject;
              if (stream) {
                  let tracks = stream.getTracks();
                  tracks.forEach(track => track.stop());
              }
              video.srcObject = null;
              lastImageData = null;
          }

          // --- AI Tip ---
          const getTipButton = document.getElementById('get-tip-button');
          const tipDisplay = document.getElementById('tip-display');

          getTipButton.addEventListener('click', () => {
              tipDisplay.style.display = 'block';
              tipDisplay.textContent = 'Analyzing your swing...';

              google.script.run
                  .withSuccessHandler(tip => {
                      tipDisplay.textContent = tip;
                  })
                  .withFailureHandler(err => {
                      tipDisplay.textContent = `Error: ${err.message}`;
                  })
                  .getGolfTip(game.lastSwingData);
          });


          // --- Event Listeners ---
          startButton.addEventListener('click', startGame);
          stopButton.addEventListener('click', stopGame);
          video.addEventListener('loadedmetadata', setupCanvas);

      })();
    </script>
  </body>
</html>
