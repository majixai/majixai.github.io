<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        :root {
            --primary-color: #00539B;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            padding-top: 20px;
        }
        .header {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .table thead th {
            background-color: #e9ecef;
        }
        .alert-info {
            background-color: #e2f3ff;
            color: #004085;
            border-color: #b8daff;
        }
        .signal-buy {
            color: #28a745;
            font-weight: bold;
        }
        .signal-sell {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="header">TradingView Alert Dashboard</h2>
        <div id="status-container">
            <div class="alert alert-info">Loading alerts from GitHub...</div>
        </div>
        <div id="table-container" style="display: none;">
            <table class="table table-striped table-bordered table-sm">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Ticker</th>
                        <th>Signal</th>
                        <th>Price</th>
                    </tr>
                </thead>
                <tbody id="alerts-tbody">
                    <!-- Data will be injected here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        /**
         * Formats an ISO string or other date string into a more readable format.
         * @param {string} dateString The date string to format.
         * @returns {string} A formatted date and time string.
         */
        function formatTimestamp(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                // Check if the date is valid
                if (isNaN(date.getTime())) {
                    return dateString; // Return original string if parsing fails
                }
                return date.toLocaleString();
            } catch (e) {
                return dateString; // Return original string on error
            }
        }

        /**
         * Renders the fetched alerts into the table.
         * @param {Array<Object>} alerts An array of alert objects.
         */
        function renderAlerts(alerts) {
            const tbody = document.getElementById('alerts-tbody');
            const statusContainer = document.getElementById('status-container');
            const tableContainer = document.getElementById('table-container');

            tbody.innerHTML = ''; // Clear previous data
            statusContainer.style.display = 'none';
            tableContainer.style.display = 'block';

            if (!alerts || alerts.length === 0) {
                statusContainer.innerHTML = '<div class="alert alert-secondary">No alerts found in the GitHub repository.</div>';
                statusContainer.style.display = 'block';
                tableContainer.style.display = 'none';
                return;
            }

            alerts.forEach(alert => {
                const row = tbody.insertRow();
                const signalType = alert.signal_type || 'N/A';
                let signalClass = '';
                if (signalType.toLowerCase().includes('buy')) {
                    signalClass = 'signal-buy';
                } else if (signalType.toLowerCase().includes('sell')) {
                    signalClass = 'signal-sell';
                }

                row.innerHTML = `
                    <td>${formatTimestamp(alert.time)}</td>
                    <td>${alert.ticker || 'N/A'}</td>
                    <td class="${signalClass}">${signalType}</td>
                    <td>${alert.price || 'N/A'}</td>
                `;
            });
        }

        /**
         * Displays an error message to the user.
         * @param {string} message The error message to display.
         */
        function showError(message) {
            const statusContainer = document.getElementById('status-container');
            statusContainer.innerHTML = `<div class="alert alert-danger">${message}</div>`;
        }

        /**
         * Main function to fetch and render data on page load.
         */
        function loadDashboard() {
            google.script.run
                .withSuccessHandler(alerts => {
                    renderAlerts(alerts);
                })
                .withFailureHandler(error => {
                    console.error("Error fetching alerts:", error);
                    let userMessage = `Failed to load alerts: ${error.message}`;
                    if (error.message.includes("not configured")) {
                        userMessage += '<br>Please open the sidebar in Google Sheets to configure your GitHub settings.';
                    }
                    showError(userMessage);
                })
                .getGitHubAlerts();
        }

        // Run the dashboard loader when the page is ready.
        window.onload = loadDashboard;
    </script>
</body>
</html>